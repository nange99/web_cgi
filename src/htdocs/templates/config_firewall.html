<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" dir="ltr">
<head>
<title>Firewall Configuration</title>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<link rel="stylesheet" type="text/css" href="/css/digistar_styles.css"/>
<link rel="stylesheet" type="text/css" href="/css/jquery-ui-1.8.2.custom.css"/>
<style type="text/css">

div#qTip {
 padding: 3px;
 border: 1px solid #666;
 border-right-width: 2px;
 border-bottom-width: 2px;
 display: none;
 background: #999;
 color: #FFF;
 font: bold 9px Verdana, Arial, Helvetica, sans-serif;
 text-align: left;
 position: absolute;
 z-index: 1000;
}

select {
	width: 100px;
}

#content table {
	padding-top: 0px;
	margin-top: 0px;
	margin-left: 20px;
}
</style>
<script type="text/javascript" src="/js/jquery-1.4.2.min.js"></script>
<script type="text/javascript" src="/js/jquery-ui-1.8.2.custom.min.js"></script>
<script type="text/javascript" src="/js/router.js"></script>
<script type="text/javascript" src="/js/menu.js"></script>
<script type="text/JavaScript" src="/js/qTip.js"></script>
<script type="text/javascript">

function makeDisable_PortRange(flag){
	makeDisable_obj_byid(flag,("portnstart"));
	makeDisable_obj_byid(flag,("portnend"));
}

function analyze_PortRange(){
	var ok = true;
	var portnStart = $("#portnstart").val();
	var portnEnd = $("#portnend").val();

	if ( isNaN(portnStart) || isNaN(portnEnd) ) 
		ok = false;

	if ( parseInt(portnStart) > parseInt(portnEnd) )
		ok = false;
	
	if (ok == true){
		set_ui_state_error_onObj($("#portnstart"),0);
		set_ui_state_error_onObj($("#portnend"),0);
	}
	else{
		set_ui_state_error_onObj($("#portnstart"),1);
		set_ui_state_error_onObj($("#portnend"),1);
	}
		
	return ok;
}

/* Fetch route table */
function updateRuleTable() {
	$.ajax({url: "/app/config_firewall?table=1", success: function(data) { $("#table_wrapper").html(data)}});
}

function deleteRule(hash) {
	if (confirm("Delete this rule?")){
		$.ajax({url: "/app/del_fw_rule?del=" + hash, success: function(data) {
			updateRuleTable();
			$("#notificationDialog").html(data);
			$("#notificationDialog").dialog("open");
		}});
	}
}

function viewRule(rule) {
	$.ajax({url: "/app/view_fw_rule?view=" + rule, success: function(data){
		 	$('#view_rule_text').attr('value',data);
		 	$('#view_dialog').dialog('open');
		
	}});

}

function refreshGeneral_Settings(){
	$("#table-applyrule_intf").load('/app/config_firewall #table-applyrule_intf');
	$.ajax({url: "/app/config_firewall", success: function(data){ 
			<?echo response.javascript?>
	}});
}


$(function() {
	
	/* Define message dialog */
	$("#notificationDialog").dialog({
		autoOpen: false,
		buttons: { "OK" : function() { $(this).dialog("close"); } },
		position: "center",
		width: 400,
		height: 230,
		modal: true
	});
	
	/* Accept or Drop */
	$("#policy-<?echo response.policy_type?>").attr("selected", "selected");

	
	/* Lock Down text box for Port Range if protocol is IP */
	$("#protocol").attr('selected',function (){
		var protocol = $("#protocol").val();
		if (protocol != "ip")
			makeDisable_PortRange(0);
		else
			makeDisable_PortRange(1);
	});
	$("#protocol").click(function (){
		var protocol = $("#protocol").val();
		if (protocol != "ip")
			makeDisable_PortRange(0);
		else{
			makeDisable_PortRange(1);
			$("#portnstart").attr('value','');
			$("#portnend").attr('value','');
		}
	});	

	
	/* Print some javascript from CGI if necessary */
	<?echo response.javascript?>
				
	$("#dialog").dialog({
		autoOpen: false,
		position: "center",
		width: 800,
		modal: true,
		buttons: {
			"Add Rule": function() {
				var ok = true;
				var dialog = $(this);

				/* Check textbox (rulename and IPs) for regularity */
				ok = !isTextFieldEmpty($("#rulename")) && ok;
				ok = !valueCompare($("#rulename"), ("-")) && ok;	
				if (ok == false)
					set_ui_state_error_onObj($("#rulename"),1);
				ok = verify_IPAddress_Mask_AnyAddr($("#src1")) && ok;
				ok = verify_IPAddress_Mask_AnyAddr($("#dest1")) && ok;

				
				/* Check PortRange textbox for regularity */
				if ( !isTextFieldEmpty($("#portnstart")) ){
					ok = inRange($("#portnstart"),1,65534) && ok;
					
					if ( isTextFieldEmpty($("#portnend")) ){
							set_ui_state_error_onObj($("#portnend"),1);		
							ok = false;
					}
					else {
						ok = inRange($("#portnend"),1,65534) && ok;
						ok = analyze_PortRange() && ok;
					}
				}
				else
					if ( !isTextFieldEmpty($("#portnend")) ){
						ok = inRange($("#portnend"),1,65534) && ok;
						if ( isTextFieldEmpty($("#portnstart")) ){
							set_ui_state_error_onObj($("#portnstart"),1);		
							ok = false;
						}
						else {
							ok = inRange($("#portnstart"),1,65534) && ok;
							ok = analyze_PortRange() && ok;
						}
					}

				
				if (ok) {
					var f = $("#fwRuleForm");
					$.post(f.get(0).action, f.serialize(), function (data) {
						dialog.dialog('close');
						updateRuleTable();
						makeDisable_PortRange(1);
						$("#notificationDialog").html(data);
						$("#notificationDialog").dialog("open");
					});
				}
				else{
						setTimeout(function () {
							$("#rulename").removeClass("ui-state-error");
							$("#src1").removeClass("ui-state-error");
							$("#dest1").removeClass("ui-state-error");
							$("#portnstart").removeClass("ui-state-error");
							$("#portnend").removeClass("ui-state-error");
						}, 3000);
						return;
					}
			},
			"Cancel": function() {
				makeDisable_PortRange(1);
				$(this).dialog('close');
			}
		},
		open: function(event, ui) { 
			//allFields.removeClass("ui-state-error");
			$("#fwRuleForm").get(0).reset(); 
		}
	
	});
	
	/* Apply settings for first tab */
	$("#fw-general-settings-apply").click(function() {
		form = $(this).parents("form").get(0);
		form_data = $(this).parents("form").serialize();

		alert("Sending form data : "+form_data);

		/* Send via AJAX and warn if configuration was successful */
		$.post(form.action, form_data, function (data) {
			$("#notificationDialog").html(data);
			$("#notificationDialog").dialog("open");
		});
	});


	$("#view_dialog").dialog({
		autoOpen: false,
		position: "center",
		width: 700,
		modal: true,
		buttons: {
			"Ok": function() {
				$(this).dialog('close');
			}
		},
		open: function(event, ui) { 
			
		}

	});
	
});

</script>
</head>

<body>
<div id="bodywrap">
<?include "/wn/cgi/templates/topmenu"?>
<?include "/wn/cgi/templates/leftmenu" ?>
	
<div id="content">
<h1>Firewall Configuration</h1>

<div id="pageTabs">
<ul>
	<li><a href="#tab-fw-general-settings" onclick="refreshGeneral_Settings()"> General Settings </a></li>
	<li><a href="#tab-fw-rules-settings"> Rules Settings </a></li>
</ul>

<div id="tab-fw-general-settings">
<form id="form-general-fw-settings" action="/app/apply_fw_general_settings" method="post">
<fieldset>
	<div>
		<label for="policy-type">Default Policy:</label>
			<select name="policy-type" id="policy-type">
			<option value="drop" id="policy-drop">Drop</option>
			<option value="accept" id="policy-accept">Accept</option>
			</select>
	</div>
</fieldset>


<fieldset>
<div id="table-applyrule_intf">
<table>
<thead class="ui-widget">
    <tr>
        <th>Interface</th>
        <th>Input Rule</th>
        <th>Output Rule</th>
        <th></th>
    </tr>
</thead>
<tbody>
<!-- Ethernet 0 -->
<tr class="odd">
	<td>
		Ethernet 0 (LAN)
	</td>
	 <td id="teste">
		<select name="ethernet0-input" id="ethernet0-input">
			<option value="--1" id="ethernet0-input-none">None</option>
			<?foreach row in response.rules_table?>
			<option value="<?echo row.rulename?>" id="ethernet0-input-<?echo row.rulename?>"><?echo row.rulename?></option>
			<?endforeach?>
		</select>
	</td>
	<td>
		<select name="ethernet0-output" id="ethernet0-output">
			<option value="--1" id="ethernet0-output-none">None</option>
			<?foreach row in response.rules_table?>
			<option value="<?echo row.rulename?>" id="ethernet0-output-<?echo row.rulename?>"><?echo row.rulename?></option>
			<?endforeach?>
		</select>
	</td>
</tr>

<!-- Ethernet 1 -->
<tr>
	<td>
		Ethernet 1 (WAN)
	</td>
	 <td>
		<select name="ethernet1-input" id="ethernet1-input">
			<option value="--1" id="ethernet1-input-none">None</option>
			<?foreach row in response.rules_table?>
			<option value="<?echo row.rulename?>" id="ethernet1-input-<?echo row.rulename?>"><?echo row.rulename?></option>
			<?endforeach?>
		</select>
	</td>
	<td>
		<select name="ethernet1-output" id="ethernet1-output">
			<option value="--1" id="ethernet1-output-none">None</option>
			<?foreach row in response.rules_table?>
			<option value="<?echo row.rulename?>" id="ethernet1-output-<?echo row.rulename?>"><?echo row.rulename?></option>
			<?endforeach?>
		</select>
	</td>
</tr>

<!-- 3G Internal -->
<tr class="odd">
	<td>
		Internal 3G Modem 0
	</td>
	 <td>
		<select name="m3g0-input" id="m3g0-input">
			<option value="--1" id="m3g0-input-none">None</option>
			<?foreach row in response.rules_table?>
			<option value="<?echo row.rulename?>" id="m3g0-intput-<?echo row.rulename?>"><?echo row.rulename?></option>
			<?endforeach?>
		</select>
	</td>
	<td>
		<select name="m3g0-output" id="m3g0-output">
			<option value="--1" id="m3g0-output-none">None</option>
			<?foreach row in response.rules_table?>
			<option value="<?echo row.rulename?>" id="m3g0-output-<?echo row.rulename?>"><?echo row.rulename?></option>
			<?endforeach?>
		</select>
	</td>
</tr>

<!-- 3G Externals -->
<tr>
	<td>
		External 3G Modem 1
	</td>
	 <td>
		<select name="m3g1-input" id="m3g1-input">
			<option value="--1" id="m3g1-input-none">None</option>
			<?foreach row in response.rules_table?>
			<option value="<?echo row.rulename?>" id="m3g1-input-<?echo row.rulename?>"><?echo row.rulename?></option>
			<?endforeach?>
		</select>
	</td>
	<td>
		<select name="m3g1-output" id="m3g1-output">
			<option value="--1" id="m3g1-output-none">None</option>
			<?foreach row in response.rules_table?>
			<option value="<?echo row.rulename?>" id="m3g1-output-<?echo row.rulename?>"><?echo row.rulename?></option>
			<?endforeach?>
		</select>
	</td>
</tr>

<tr class="odd">
	<td>
		External 3G Modem 2
	</td>
	 <td>
		<select name="m3g2-input" id="m3g2-input">
			<option value="--1" id="m3g2-input-none">None</option>
			<?foreach row in response.rules_table?>
			<option value="<?echo row.rulename?>" id="m3g2-input-<?echo row.rulename?>"><?echo row.rulename?></option>
			<?endforeach?>
		</select>
	</td>
	<td>
		<select name="m3g2-output" id="m3g2-output">
			<option value="--1" id="m3g2-output-none">None</option>
			<?foreach row in response.rules_table?>
			<option value="<?echo row.rulename?>" id="m3g2-output-<?echo row.rulename?>"><?echo row.rulename?></option>
			<?endforeach?>
		</select>
	</td>
</tr>

</tbody>
</table>

</div>
<div style="float:right;padding-top:50px;padding-right:50px">		 
	<input type="button" id="fw-general-settings-apply" value="Apply Settings" class="text ui-widget-content ui-corner-all"/>
</div>
	
</fieldset>
</form>
</div> <!-- tab-gw-general-settings -->


<div id="tab-fw-rules-settings">
	<div id="context_menu">
		<ul>
			<li class="context_item"><a href="#" onclick="$('#dialog').dialog('open');"><b><u>Add rule</u></b></a></li>
		</ul>
	</div>
	<div id="table_wrapper">
		<table>
		<thead>
		    <tr>
		        <th>Rule Name</th>
		        <th></th>
		    </tr>
		</thead>
		<tbody>
		    <?foreach row in response.rules_table?>
				<?if odd_ then?>
					<tr>
				<?else?>
					<tr class="odd">
				<?endif?>
					  <td><?echo row.rulename?></td>
					  <td><a href="#" onclick="viewRule('<?echo row.rulename?>');">View Details</a></td>
					  <td><a href="#" onclick="deleteRule('<?echo row.rulename?>');">Delete Rule</a></td>
					</tr>
			<?endforeach?>
		</tbody>
</table>
</div>

<div id="dialog" title="Add Firewall Rule">
<form id="fwRuleForm" action="/app/add_fw_rule" method="post">
<fieldset>
	<legend>Rule Configuration</legend>
	
	<div>
		<label for="name">Name: </label>
		<input type="text" name="rulename" id="rulename" class="text ui-widget-content ui-corner-all"/>
	</div>
	
	
	<table>
	<!-- entry 1 -->
		<tr>
			<td>
				<div>
					<label for="policy">Policy: </label>
					<select name="policy" id="policy" style="width:120px" class="text ui-widget-content ui-corner-all">
							<option value="accept" id="rule-policy-accept">Accept</option>
							<option value="drop"   id="rule-policy-drop"  >Drop</option>
							<option value="reject" id="rule-policy-reject">Reject</option>
					</select>
				</div>
			</td>
			
			<td>
				<div>
					<label for="protocol">Protocol: </label>
					<select name="protocol" id="protocol" style="width:120px" class="text ui-widget-content ui-corner-all">
							<option value="ip"  id="rule-protocol-ip" >IP</option>
							<option value="tcp" id="rule-protocol-tcp">TCP</option>
							<option value="udp" id="rule-protocol-udp">UDP</option>
					</select>
				</div>
			</td>
		</tr>
		<tr>
			<td>
				<div>
					<label for="src1">Source:</label>
					<input type="text" name="src1" id="src1" style="width:120px" title="IP[/Mask] or just IP - Ex: 192.168.0.1/255.255.255.255 -- For any addr. put (*)" class="text ui-widget-content ui-corner-all"/>
				</div>
			</td>

			<td>
				<div>
					<label for="dest1">Destination:</label>
					<input type="text" name="dest1" id="dest1" style="width:120px" title="IP[/Mask] or just IP - Ex: 192.168.0.1/255.255.255.255 -- For any addr. put (*)" class="text ui-widget-content ui-corner-all"/>
				</div>
			</td>
		</tr>
		
		<tr>	
			<td>
				<div>
					<label for="portn" title="Numbers between 1-65534, or blank - [For a unique port, put the same number at the fields]">Port Range:</label>
					<input type="text" name="portnstart" id="portnstart" disabled=true style="width:50px" title="Value1 < Value2" class="text ui-widget-content ui-corner-all"/>
					-
					<input type="text" name="portnend" id="portnend" disabled=true style="width:50px" title="Value1 < Value2" class="text ui-widget-content ui-corner-all"/>
				</div>
			</td>
		</tr>
	</table>

	
</fieldset>
</form>
</div> <!-- tab-gw-rules-settings -->


<div id="view_dialog" title="View Rule">
	<form id="ViewForm" method="post">
		<fieldset>
			<legend>Rule Configuration</legend>
				<textarea id = "view_rule_text" readonly="1" rows="10" cols="80" >		
				</textarea>	
		</fieldset>
	</form>
</div> <!-- view_dialog -->


</div> <!-- pageTabs -->

<div id="notificationDialog" title="Notification">
</div>

</div> <!-- content -->
</div> <!-- bodywrap -->
</body>
</html>
