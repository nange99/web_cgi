<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" dir="ltr">
<head>
<title>Firewall Configuration</title>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<link rel="stylesheet" type="text/css" href="/css/digistar_styles.css"/>
<link rel="stylesheet" type="text/css" href="/css/jquery-ui-1.8.2.custom.css"/>
<style type="text/css">
select {
	width: 100px;
}

#content table {
	padding-top: 0px;
	margin-top: 0px;
	margin-left: 20px;
}
</style>
<script type="text/javascript" src="/js/jquery-1.4.2.min.js"></script>
<script type="text/javascript" src="/js/jquery-ui-1.8.2.custom.min.js"></script>
<script type="text/javascript" src="/js/router.js"></script>
<script type="text/javascript" src="/js/menu.js"></script>
<script type="text/javascript">
/* Local script go here! */
function deleteFwRule(hash) {
	if (confirm("Delete this rule?"))
		$.ajax({url: "/app/config_firewall?del=" + hash, success: function(data) { $("#table_wrapper").html(data)}});
}

$(function() {

	/* Accept or Drop */
	$("#policy-<?echo response.policy_type?>").attr("selected", "selected");

	/* Print some javascript from CGI if necessary */
	<?echo response.javascript?>
	
	/* Fetch route table */
	function updateRuleTable() {
		$.ajax({url: "/app/config_firewall?table=1", success: function(data) { $("#table_wrapper").html(data)}});
	}
	
	$("#dialog").dialog({
		autoOpen: false,
		position: "center",
		width: 800,
		modal: true,
		buttons: {
			"Add Rule": function() {
				var ok = true;
				var dialog = $(this);
				ok = verifyIPAddress(destination) && ok;
				ok = verifyIPAddress(gateway) && ok;
				ok = verifyIPAddress(mask) && ok;
	
				if (ok) {
					var f = $("#fwRuleForm");
					$.post(f.get(0).action, f.serialize(), function (data) {
						dialog.dialog('close');
						updateRuleTable();
					});
				}
			},
			"Cancel": function() {
				$(this).dialog('close');
			}
		},
		open: function(event, ui) { 
			allFields.removeClass("ui-state-error");
			$("#fwRuleForm").get(0).reset(); 
		}
	});

	/* Apply settings for first tab */
	$("#fw-general-settings-apply").click(function () {
		form = $(this).parents("form").get(0);
		form_data = $(this).parents("form").serialize();

		alert("Sending form data : "+form_data);

		/* Send via AJAX and warn if configuration was successful */
		$.post(form.action, form_data, function (data) {
			$("#notificationDialog").html(data);
			$("#notificationDialog").dialog("open");
		});
	});
	
});

</script>
</head>

<body>
<div id="bodywrap">
<?include "/wn/cgi/templates/topmenu"?>
<?include "/wn/cgi/templates/leftmenu" ?>
	
<div id="content">
<h1>Firewall Configuration</h1>

<div id="pageTabs">
<ul>
	<li><a href="#tab-fw-general-settings"> General Settings </a></li>
	<li><a href="#tab-fw-rules-settings"> Rules Settings </a></li>
</ul>

<div id="tab-fw-general-settings">
<form id="form-general-fw-settings" action="/app/apply_fw_general_settings" method="post">
<fieldset>
	<div>
		<label for="policy-type">Default Policy:</label>
			<select id="policy-type" name="policy_type">
			<option value="drop" id="policy-drop">Drop</option>
			<option value="accept" id="policy-accept">Accept</option>
			</select>
	</div>
</fieldset>


<fieldset>
<div>
<table>
<thead class="ui-widget">
    <tr>
        <th>Interface</th>
        <th>Input Rule</th>
        <th>Output Rule</th>
        <th></th>
    </tr>
</thead>
<tbody>
<!-- Ethernet 0 -->
<tr class="odd">
	<td>
		Ethernet 0 (LAN)
	</td>
	 <td>
		<select name="ethernet0-input">
			<option value="none" id="ethernet0-input-none">None</option>
			<?foreach row in response.rules_table?>
			<option value="<?echo row.rulename?>" id="ethernet0-input-<?echo row.rulename?>"><?echo row.rulename?></option>
			<?endforeach?>
		</select>
	</td>
	<td>
		<select name="ethernet0-output">
			<option value="none" id="ethernet0-output-none">None</option>
			<?foreach row in response.rules_table?>
			<option value="<?echo row.rulename?>" id="ethernet0-output-<?echo row.rulename?>"><?echo row.rulename?></option>
			<?endforeach?>
		</select>
	</td>
</tr>

<!-- Ethernet 1 -->
<tr>
	<td>
		Ethernet 1 (WAN)
	</td>
	 <td>
		<select name="ethernet1-input">
			<option value="none" id="ethernet1-input-none">None</option>
			<?foreach row in response.rules_table?>
			<option value="<?echo row.rulename?>" id="ethernet1-input-<?echo row.rulename?>"><?echo row.rulename?></option>
			<?endforeach?>
		</select>
	</td>
	<td>
		<select name="ethernet1-output">
			<option value="none" id="ethernet1-output-none">None</option>
			<?foreach row in response.rules_table?>
			<option value="<?echo row.rulename?>" id="ethernet1-output-<?echo row.rulename?>"><?echo row.rulename?></option>
			<?endforeach?>
		</select>
	</td>
</tr>

<!-- 3G Internal -->
<tr class="odd">
	<td>
		Internal 3G Modem
	</td>
	 <td>
		<select name="m3g0-input">
			<option value="none" id="m3g0-input-none">None</option>
			<?foreach row in response.rules_table?>
			<option value="<?echo row.rulename?>" id="m3g0-intput-<?echo row.rulename?>"><?echo row.rulename?></option>
			<?endforeach?>
		</select>
	</td>
	<td>
		<select name="m3g0-output">
			<option value="none" id="m3g0-output-none">None</option>
			<?foreach row in response.rules_table?>
			<option value="<?echo row.rulename?>" id="m3g0-output-<?echo row.rulename?>"><?echo row.rulename?></option>
			<?endforeach?>
		</select>
	</td>
</tr>

<!-- 3G Externals -->
<tr>
	<td>
		External 3G Modem 0
	</td>
	 <td>
		<select name="m3g1-input">
			<option value="none" id="m3g1-input-none">None</option>
			<?foreach row in response.rules_table?>
			<option value="<?echo row.rulename?>" id="m3g1-intput-<?echo row.rulename?>"><?echo row.rulename?></option>
			<?endforeach?>
		</select>
	</td>
	<td>
		<select name="m3g1-output">
			<option value="none" id="m3g1-output-none">None</option>
			<?foreach row in response.rules_table?>
			<option value="<?echo row.rulename?>" id="m3g1-output-<?echo row.rulename?>"><?echo row.rulename?></option>
			<?endforeach?>
		</select>
	</td>
</tr>

<tr class="odd">
	<td>
		External 3G Modem 1
	</td>
	 <td>
		<select name="m3g2-input">
			<option value="none" id="m3g2-input-none">None</option>
			<?foreach row in response.rules_table?>
			<option value="<?echo row.rulename?>" id="m3g2-intput-<?echo row.rulename?>"><?echo row.rulename?></option>
			<?endforeach?>
		</select>
	</td>
	<td>
		<select name="m3g2-output">
			<option value="none" id="m3g2-output-none">None</option>
			<?foreach row in response.rules_table?>
			<option value="<?echo row.rulename?>" id="m3g2-output-<?echo row.rulename?>"><?echo row.rulename?></option>
			<?endforeach?>
		</select>
	</td>
</tr>
</tbody>
</table>

</div>
<div style="float:right;padding-top:50px;padding-right:50px">		 
	<input type="button" id="fw-general-settings-apply" value="Apply Settings" class="text ui-widget-content ui-corner-all"/>
</div>
	
</fieldset>
</form>
</div> <!-- tab-gw-general-settings -->


<div id="tab-fw-rules-settings">
	<div id="context_menu">
		<ul>
			<li class="context_item"><a href="#" onclick="$('#dialog').dialog('open');">Add rule</a></li>
		</ul>
	</div>
	<div id="table_wrapper">
		<table>
		<thead>
		    <tr>
		        <th>Rule Name</th>
		        <th></th>
		    </tr>
		</thead>
		<tbody>
		    <?foreach row in response.rules_table?>
				<?if odd_ then?>
					<tr>
				<?else?>
					<tr class="odd">
				<?endif?>
					  <td><?echo row.rulename?></td>
					  <td><a href="#" onclick="deleteRoute('<?echo row.hash?>');">View Details</a></td>
					  <td><a href="#" onclick="deleteRoute('<?echo row.hash?>');">Edit Rule</a></td>
					  <td><a href="#" onclick="deleteRoute('<?echo row.hash?>');">Delete Rule</a></td>
					</tr>
			<?endforeach?>
		</tbody>
</table>
</div>

<div id="dialog" title="Add Firewall Rule">
<form id="fwRuleForm" action="/app/add_fw_rule" method="post">
<fieldset>
	<legend>Rule Configuration</legend>
	
	<div>
	<label for="name">Name: </label>
	<input type="text" name="name" id="name" class="text ui-widget-content ui-corner-all"/>
	</div>
	
	
	<table>
	<!-- entry 1 -->
	<tr>
	<td>
		<div>
		<label for="policy">Policy: </label>
		<select name="policy" id="policy" style="width:120px" class="text ui-widget-content ui-corner-all">
				<option value="drop" id="rule-policy-drop">Drop</option>
				<option value="accept" id="rule-policy-accept">Accept</option>
				<option value="reject" id="rule-policy-reject">Reject</option>
		</select>
		</div>
	</td>
	
	<td><div>
	<label for="src1">Source:</label>
	<input type="text" name="src1" id="src1" style="width:120px" class="text ui-widget-content ui-corner-all"/>
	</div></td>

	<td><div>
	<label for="dest1">Destination:</label><input type="text" name="dest1" id="dest1" style="width:120px" class="text ui-widget-content ui-corner-all"/>
	</div></td></tr>
	</table>

	
</fieldset>
</form>
</div> <!-- tab-gw-rules-settings -->


</div> <!-- pageTabs -->

<div id="notificationDialog" title="Notification">
</div>

</div> <!-- content -->
</div> <!-- bodywrap -->
</body>
</html>
